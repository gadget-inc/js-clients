{"version":3,"file":"useSession.js","sourceRoot":"","sources":["../../../src/auth/useSession.ts"],"names":[],"mappings":"AAEA,OAAO,EAAE,MAAM,EAAE,MAAM,EAAE,MAAM,aAAa,CAAC;AAkB7C;;;GAGG;AACH,MAAM,UAAU,UAAU,CASxB,MAAmB,EACnB,OAA0G;IAiB1G,MAAM,WAAW,GAAG,MAAM,EAAE,CAAC;IAC7B,MAAM,GAAG,GAAG,MAAM,IAAK,WAA0B,CAAC;IAElD,IAAI,GAAG,IAAI,gBAAgB,IAAI,GAAG,IAAI,SAAS,IAAI,GAAG,EAAE,CAAC;QACvD,MAAM,EAAE,MAAM,EAAE,SAAS,EAAE,GAAG,WAAW,EAAE,GAAG,OAAO,IAAK,EAAU,CAAC;QACrE,MAAM,EAAE,IAAI,EAAE,UAAU,EAAE,GAAG,aAAa,EAAE,GAAG,SAAS,IAAI,EAAE,IAAI,EAAE,SAAS,EAAE,CAAC;QAChF,MAAM,gBAAgB,GAAG,MAAM,CAAC,IAAI,CAAC,aAAa,CAAC,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC,CAAC,aAAa,CAAC,CAAC,CAAC,GAAG,CAAC,cAAc,CAAC,GAAG,CAAC,gBAAgB,CAAC;QACzH,MAAM,aAAa,GAAG,UAAU,CAAC,CAAC,CAAC,UAAU,CAAC,CAAC,CAAC,GAAG,CAAC,IAAI,EAAE,QAAQ,CAAC,gBAAgB,CAAC;QAEpF,MAAM,IAAI,GAAQ;YAChB,QAAQ,EAAE,IAAI;YACd,MAAM,EAAE;gBACN,GAAG,gBAAgB;gBACnB,GAAG,CAAC,aAAa,IAAI,EAAE,IAAI,EAAE,aAAa,EAAE,CAAC;aAC9C;YACD,GAAG,CAAC,WAAW,IAAI,EAAE,CAAC;SACvB,CAAC;QAEF,0GAA0G;QAC1G,MAAM,CAAC,EAAE,IAAI,EAAE,OAAO,EAAE,KAAK,EAAE,CAAC,GAAG,MAAM,CAAC,GAAG,CAAC,cAAc,EAAE,IAAI,CAAC,CAAC;QAEpE,IAAI,KAAK;YAAE,MAAM,KAAK,CAAC;QACvB,IAAI,CAAC,OAAO;YAAE,MAAM,IAAI,KAAK,CAAC,gDAAgD,CAAC,CAAC;QAChF,4EAA4E;QAC5E,OAAO,OAAO,MAAM,IAAI,WAAW,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,CAAE,OAAe,CAAC;IACnE,CAAC;SAAM,CAAC;QACN,MAAM,IAAI,KAAK,CAAC,0CAA0C,CAAC,CAAC;IAC9D,CAAC;AACH,CAAC","sourcesContent":["import type { OptionsType, ReadOperationOptions } from \"@gadgetinc/client-hooks\";\nimport type { AnyClient, DefaultSelection, FindManyFunction, GadgetRecord, GetFunction, LimitToKnownKeys, Select } from \"@gadgetinc/core\";\nimport { useApi, useGet } from \"../hooks.js\";\n\nexport type GadgetSession = GadgetRecord<Record<string, any>>;\n\nexport type GadgetUser = GadgetRecord<Record<string, any>>;\n\nexport type ClientWithSessionAndUserManagers<SessionGivenOptions, SessionSchemaT, UserGivenOptions, UserSchemaT> = AnyClient & {\n  currentSession: { get: GetFunction<SessionGivenOptions, any, SessionSchemaT, any> };\n  user: { findMany: FindManyFunction<UserGivenOptions, any, UserSchemaT, any> };\n};\n\nexport type ClientWithSessionAndMaybeUserManagers<SessionGivenOptions, SessionSchemaT, UserGivenOptions, UserSchemaT> = Omit<\n  ClientWithSessionAndUserManagers<SessionGivenOptions, SessionSchemaT, UserGivenOptions, UserSchemaT>,\n  \"user\"\n> & {\n  user?: { findMany: FindManyFunction<UserGivenOptions, any, UserSchemaT, any> };\n};\n\n/**\n * Used for fetching the current `Session` record from Gadget. Will suspend while the user is being fetched.\n * @returns The current session\n */\nexport function useSession<\n  SessionGivenOptions extends OptionsType,\n  SessionSchemaT,\n  UserGivenOptions extends OptionsType,\n  UserSchemaT,\n  Client extends ClientWithSessionAndMaybeUserManagers<SessionGivenOptions, SessionSchemaT, UserGivenOptions, UserSchemaT>,\n  Options extends Client[\"currentSession\"][\"get\"][\"optionsType\"] & ReadOperationOptions,\n  ClientType extends Client | undefined,\n>(\n  client?: ClientType,\n  options?: LimitToKnownKeys<Options, Client[\"currentSession\"][\"get\"][\"optionsType\"] & ReadOperationOptions>\n): undefined extends ClientType\n  ? GadgetSession\n  : GadgetRecord<\n      Select<\n        Exclude<Exclude<ClientType, undefined>[\"currentSession\"][\"get\"][\"schemaType\"], null | undefined>,\n        DefaultSelection<\n          Exclude<ClientType, undefined>[\"currentSession\"][\"get\"][\"selectionType\"],\n          Options,\n          Exclude<ClientType, undefined>[\"currentSession\"][\"get\"][\"defaultSelection\"] & {\n            user: Exclude<ClientType, undefined>[\"user\"] extends { findMany: FindManyFunction<UserGivenOptions, any, UserSchemaT, any> }\n              ? Exclude<ClientType, undefined>[\"user\"][\"findMany\"][\"defaultSelection\"]\n              : never;\n          }\n        >\n      >\n    > {\n  const fallbackApi = useApi();\n  const api = client ?? (fallbackApi as ClientType);\n\n  if (api && \"currentSession\" in api && \"session\" in api) {\n    const { select: selection, ...restOptions } = options ?? ({} as any);\n    const { user: userSelect, ...sessionSelect } = selection ?? { user: undefined };\n    const sessionSelection = Object.keys(sessionSelect).length > 0 ? sessionSelect : api.currentSession.get.defaultSelection;\n    const userSelection = userSelect ? userSelect : api.user?.findMany.defaultSelection;\n\n    const opts: any = {\n      suspense: true,\n      select: {\n        ...sessionSelection,\n        ...(userSelection && { user: userSelection }),\n      },\n      ...(restOptions ?? {}),\n    };\n\n    // oxlint-disable-next-line react/rules-of-hooks -- else branch always throws, so hook order is consistent\n    const [{ data: session, error }] = useGet(api.currentSession, opts);\n\n    if (error) throw error;\n    if (!session) throw new Error(\"currentSession not found but should be present\");\n    // eslint-disable-next-line @typescript-eslint/no-unnecessary-type-assertion\n    return typeof client == \"undefined\" ? session : (session as any);\n  } else {\n    throw new Error(\"api client does not have a Session model\");\n  }\n}\n"]}