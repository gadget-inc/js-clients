{"version":3,"file":"AutoForm.js","sourceRoot":"","sources":["../../../src/auto/AutoForm.ts"],"names":[],"mappings":"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","sourcesContent":["import type { ActionFunction, GadgetRecord, GlobalActionFunction } from \"@gadgetinc/api-client-core\";\nimport { yupResolver } from \"@hookform/resolvers/yup\";\nimport type { ReactNode } from \"react\";\nimport { useEffect, useMemo, useRef } from \"react\";\nimport type { AnyActionWithId, RecordIdentifier, UseActionFormHookStateData } from \"src/use-action-form/types.js\";\nimport type { GadgetObjectFieldConfig } from \"../internal/gql/graphql.js\";\nimport type { FieldMetadata, GlobalActionMetadata, ModelWithOneActionMetadata } from \"../metadata.js\";\nimport { FieldType, filterAutoFormFieldList, isModelActionMetadata, useActionMetadata } from \"../metadata.js\";\nimport type { FieldErrors, FieldValues } from \"../useActionForm.js\";\nimport { useActionForm } from \"../useActionForm.js\";\nimport { get, getFlattenedObjectKeys, type OptionsType } from \"../utils.js\";\nimport { validationSchema } from \"../validationSchema.js\";\nimport {\n  validateFindByObjectWithMetadata,\n  validateNonBulkAction,\n  validateTriggersFromApiClient,\n  validateTriggersFromMetadata,\n} from \"./AutoFormActionValidators.js\";\n\n/** The props that any <AutoForm/> component accepts */\nexport type AutoFormProps<\n  GivenOptions extends OptionsType,\n  SchemaT,\n  ActionFunc extends ActionFunction<GivenOptions, any, any, SchemaT, any> | GlobalActionFunction<any>,\n  ExtraFormVariables extends FieldValues = Record<string, unknown>,\n  DefaultValues = ActionFunc[\"variablesType\"] & ExtraFormVariables\n> = {\n  /** Which action this fom will run on submit */\n  action: ActionFunc;\n  /** A record for this form to act on */\n  record?: GadgetRecord<any>;\n  /** An allowlist of fields to render within the form. Only these fields will be rendered as inputs. */\n  include?: string[];\n  /** A denylist of fields to render within the form. Every field except these fields will be rendered as inputs. */\n  exclude?: string[];\n  /** A set of field values to pre-populate the form with on load. Only applies to create forms. */\n  defaultValues?: DefaultValues;\n  /** The label to use for the submit button at the bottom of the form */\n  submitLabel?: ReactNode;\n  /** What to show the user once the form has been submitted successfully */\n  successContent?: ReactNode;\n  /** The title at the top of the form. False to omit */\n  title?: string | false;\n  /** Called when the form submission completes successfully on the backend */\n  onSuccess?: (record: UseActionFormHookStateData<ActionFunc>) => void;\n  /** Called when the form submission errors before sending, during the API call, or if the API call returns an error. */\n  onFailure?: (error: Error | FieldErrors<ActionFunc[\"variablesType\"]>) => void;\n  /** Custom components to render within the form. Using this will override all default field rendering.   */\n  children?: ReactNode;\n} & (ActionFunc extends AnyActionWithId<GivenOptions>\n  ? {\n      /**\n       * The record identifier to run this action on, if it already exists.\n       * Should be undefined for create actions, or a record ID (or finder) for update / etc actions\n       **/\n      findBy?: RecordIdentifier;\n    }\n  : // eslint-disable-next-line @typescript-eslint/ban-types\n    {});\n\n/**\n * React hook for getting the validation schema for a list of fields\n */\nconst useValidationResolver = (metadata: ModelWithOneActionMetadata | GlobalActionMetadata | undefined, pathsToValidate: string[]) => {\n  return useMemo(() => {\n    if (!metadata) return undefined;\n    const action = isModelActionMetadata(metadata) ? metadata.action : metadata;\n    return yupResolver(validationSchema(action.inputFields, pathsToValidate));\n  }, [metadata, pathsToValidate]);\n};\n\n/**\n * React hook for getting a list of fields to use in a form (given include/exclude options)\n */\nexport const useFormFields = (\n  metadata: ModelWithOneActionMetadata | GlobalActionMetadata | undefined | null,\n  options: { include?: string[]; exclude?: string[] }\n): readonly { path: string; metadata: FieldMetadata }[] => {\n  return useMemo(() => {\n    if (!metadata) return [];\n    const action = isModelActionMetadata(metadata) ? metadata.action : metadata;\n\n    const isModelMetadata = metadata.__typename === \"GadgetModel\";\n\n    const objectFields = isModelMetadata\n      ? action.inputFields.filter(\n          (field) => field.configuration.__typename === \"GadgetObjectFieldConfig\" && field.apiIdentifier === metadata.apiIdentifier\n        )\n      : [];\n    const nonObjectFields = action.inputFields.filter((field) => field.configuration.__typename !== \"GadgetObjectFieldConfig\");\n\n    const includedRootLevelFields = filterAutoFormFieldList(nonObjectFields, options as any).map(\n      (field) =>\n        ({\n          path: field.apiIdentifier,\n          metadata: field,\n        } as const)\n    );\n\n    const includedObjectFields = objectFields.flatMap((objectField) =>\n      filterAutoFormFieldList((objectField.configuration as unknown as GadgetObjectFieldConfig).fields as any, {\n        ...(options as any),\n        isUpsertAction: true, // For upsert meta-actions, we allow IDs, and they are object fields instead of root level\n      }).map(\n        (innerField) =>\n          ({\n            path: `${objectField.apiIdentifier}.${innerField.apiIdentifier}`,\n            metadata: innerField,\n          } as const)\n      )\n    );\n\n    const allFormFields = [...includedObjectFields, ...includedRootLevelFields];\n    validateFormFieldApiIdentifierUniqueness(\n      action.apiIdentifier,\n      allFormFields.map(({ metadata }) => metadata.apiIdentifier)\n    );\n\n    return allFormFields;\n  }, [metadata, options]);\n};\n\nconst validateFormFieldApiIdentifierUniqueness = (actionApiIdentifier: string, inputApiIdentifiers: string[]) => {\n  const seen = new Set<string>();\n\n  for (const apiId of inputApiIdentifiers) {\n    if (seen.has(apiId)) {\n      throw new Error(`Input \"${apiId}\" is not unique for action \"${actionApiIdentifier}\"`);\n    }\n    seen.add(apiId);\n  }\n};\n\n/**\n * Internal React hook for sharing logic between different `AutoForm` components.\n * @internal\n */\nexport const useAutoForm = <\n  GivenOptions extends OptionsType,\n  SchemaT,\n  ActionFunc extends ActionFunction<GivenOptions, any, any, SchemaT, any> | GlobalActionFunction<any>\n>(\n  props: AutoFormProps<GivenOptions, SchemaT, ActionFunc, any, any> & { findBy?: any }\n) => {\n  const { action, record, onSuccess, onFailure, findBy } = props;\n\n  validateNonBulkAction(action);\n  validateTriggersFromApiClient(action);\n\n  const { metadata, fetching: fetchingMetadata, error: metadataError } = useActionMetadata(props.action);\n\n  validateTriggersFromMetadata(metadata);\n\n  // filter down the fields to render only what we want to render for this form\n  const fields = useFormFields(metadata, props);\n  validateFindByObjectWithMetadata(fields, findBy);\n  const isDeleteAction = metadata && isModelActionMetadata(metadata) && metadata.action.isDeleteAction;\n  const isGlobalAction = action.type === \"globalAction\";\n  const operatesWithRecordId = !!(metadata && isModelActionMetadata(metadata) && metadata.action.operatesWithRecordIdentity);\n  const modelApiIdentifier = action.type == \"action\" ? action.modelApiIdentifier : undefined;\n  const isUpsertMetaAction =\n    metadata && isModelActionMetadata(metadata) && fields.some((field) => field.metadata.fieldType === FieldType.Id);\n  const isUpsertWithFindBy = isUpsertMetaAction && !!findBy;\n  const hasCustomChildren = !!props.children;\n  const fieldPathsToValidate = useMemo(\n    () =>\n      hasCustomChildren\n        ? [] // With custom children, do not validate fields before sending them to avoid blocking submissions due to missing required fields\n        : fields.map(({ path }) => path),\n    [hasCustomChildren, fields]\n  );\n\n  const defaultValues: Record<string, unknown> = useMemo(\n    () =>\n      props.defaultValues ??\n      (action.type === \"globalAction\"\n        ? {}\n        : {\n            [modelApiIdentifier!]:\n              record ??\n              (!(operatesWithRecordId || isUpsertWithFindBy) && metadata && isModelActionMetadata(metadata) && metadata?.defaultRecord),\n            id:\n              typeof findBy === \"string\"\n                ? findBy // ID is given directly\n                : undefined, // Set by the retrieved existing record if object based findBy value\n          }),\n    [props.defaultValues, action.type, modelApiIdentifier, record, operatesWithRecordId, metadata, findBy]\n  );\n\n  // setup the form state for the action\n  const {\n    submit,\n    error: formError,\n    reset,\n    setValue,\n    getValues,\n\n    formState: { isSubmitSuccessful, isLoading, isReady, isSubmitting, touchedFields, errors },\n    originalFormMethods,\n  } = useActionForm(action, {\n    defaultValues: defaultValues as any,\n    findBy: \"findBy\" in props ? props.findBy : undefined,\n    throwOnInvalidFindByObject: false,\n    resolver: useValidationResolver(metadata, fieldPathsToValidate),\n    send: () => {\n      const fieldsToSend = fields\n        .filter(({ path, metadata }) => {\n          const fieldType = metadata.fieldType;\n          const isUntouchedPasswordField = fieldType === FieldType.Password && \"findBy\" in props && !get(touchedFields, path);\n          if (isUntouchedPasswordField) {\n            // Never send the password field if it hasn't been touched. Doing so will clear the record value\n            return false;\n          }\n\n          if (props.include) {\n            return props.include?.includes(metadata.apiIdentifier);\n          } else if (props.exclude) {\n            return !props.exclude?.includes(metadata.apiIdentifier);\n          }\n          return true;\n        })\n        .map(({ path }) => path);\n\n      if (operatesWithRecordId) {\n        fieldsToSend.push(\"id\");\n      }\n\n      if (props.defaultValues && modelApiIdentifier) {\n        // Add any explicitly set default values to the fields to send in the event that they are not included\n        const explicityDefaultedPaths = getFlattenedObjectKeys(props.defaultValues);\n        explicityDefaultedPaths.forEach((path) => {\n          if (!fieldsToSend.includes(path)) {\n            fieldsToSend.push(path);\n          }\n        });\n      }\n\n      return fieldsToSend;\n    },\n    onError: onFailure,\n    onSuccess:\n      onSuccess ??\n      function clearInputValues() {\n        const isCreateAction = !operatesWithRecordId && !isDeleteAction && !isGlobalAction && !isUpsertMetaAction;\n        const isUpsertWithoutFindBy = isUpsertMetaAction && !isUpsertWithFindBy;\n        if (isCreateAction || isGlobalAction || isUpsertWithoutFindBy) {\n          reset();\n        }\n      },\n  });\n\n  // we don't have synchronous access to the default values always -- sometimes we need to load them from the metadata. if we do that, then we need to forcibly set them into the form state once they have been loaded\n  const hasSetInitialValues = useRef<boolean>(false);\n  useEffect(() => {\n    if (isReady && !hasSetInitialValues.current && modelApiIdentifier && defaultValues[modelApiIdentifier]) {\n      hasSetInitialValues.current = true;\n      originalFormMethods.reset(defaultValues);\n    }\n  }, [isReady, defaultValues, originalFormMethods, modelApiIdentifier]);\n\n  if (!fetchingMetadata) {\n    validateFindBy({ operatesWithRecordId, hasFindBy: !!findBy, isUpsertMetaAction: !!isUpsertMetaAction });\n  }\n\n  useEffect(() => {\n    if (isUpsertWithFindBy) {\n      setValue(`${modelApiIdentifier!}.id`, findBy); // Upsert actions use model.id instead of use root level api value\n    }\n  }, [getValues(`${modelApiIdentifier!}.id`), isUpsertWithFindBy]);\n\n  return {\n    metadata,\n    fetchingMetadata,\n    metadataError,\n    fields: fields.filter(removeIdFieldsUnlessUpsertWithoutFindBy(isUpsertWithFindBy)),\n    submit,\n    formError,\n    isSubmitting,\n    isSubmitSuccessful,\n    isLoading,\n    originalFormMethods,\n  };\n};\n\nconst removeIdFieldsUnlessUpsertWithoutFindBy = (isUpsertWithFindBy?: boolean) => {\n  return (field: { metadata: FieldMetadata }) => {\n    return field.metadata.fieldType === FieldType.Id ? !isUpsertWithFindBy : true;\n  };\n};\n\nconst validateFindBy = (params: { operatesWithRecordId: boolean; hasFindBy: boolean; isUpsertMetaAction: boolean }) => {\n  const { operatesWithRecordId, hasFindBy, isUpsertMetaAction } = params;\n\n  if (isUpsertMetaAction) {\n    return; // optional findBy value for upsert meta actions\n  }\n\n  if (operatesWithRecordId && !hasFindBy) {\n    throw new Error(\"The 'findBy' prop is required for actions that operate with a record identity.\");\n  } else if (!operatesWithRecordId && hasFindBy) {\n    throw new Error(\"The 'findBy' prop is only allowed for actions that operate with a record identity.\");\n  }\n};\n"]}