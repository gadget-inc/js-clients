{"version":3,"file":"ShadcnAutoHasManyThroughForm.js","sourceRoot":"","sources":["../../../../../../src/auto/shadcn/inputs/relationships/ShadcnAutoHasManyThroughForm.tsx"],"names":[],"mappings":"AAAA,OAAO,EAAE,cAAc,EAAE,QAAQ,EAAE,CAAC,EAAE,MAAM,cAAc,CAAC;AAC3D,OAAO,KAAK,EAAE,EAAE,WAAW,EAAE,QAAQ,EAAE,MAAM,OAAO,CAAC;AACrD,OAAO,EAAE,qBAAqB,EAAE,MAAM,sCAAsC,CAAC;AAC7E,OAAO,EAAE,QAAQ,EAAE,MAAM,sBAAsB,CAAC;AAChD,OAAO,EAAE,oBAAoB,EAAE,MAAM,uBAAuB,CAAC;AAC7D,OAAO,EAAE,mBAAmB,EAAE,MAAM,uCAAuC,CAAC;AAC5E,OAAO,EAAE,iBAAiB,EAAE,MAAM,mCAAmC,CAAC;AAGtE,OAAO,EAAE,2BAA2B,EAAE,MAAM,gBAAgB,CAAC;AAC7D,OAAO,EAAE,wBAAwB,EAAE,MAAM,4BAA4B,CAAC;AAEtE,MAAM,CAAC,MAAM,gCAAgC,GAAG,CAAC,EAC/C,KAAK,EACL,MAAM,EACN,KAAK,EACL,OAAO,EACP,YAAY,EACZ,WAAW,EACX,WAAW,EACX,YAAY,EACZ,YAAY,EACZ,QAAQ,EACR,OAAO,EACP,cAAc,EACd,cAAc,GAgBf,EAAE,EAAE;IACH,MAAM,gBAAgB,GAAG,wBAAwB,CAAC;QAChD,OAAO;QACP,YAAY;QACZ,KAAK;QACL,WAAW;QACX,WAAW;QACX,YAAY;QACZ,YAAY;QACZ,QAAQ;KACT,CAAC,CAAC;IAEH,MAAM,iBAAiB,GAAG,2BAA2B,CAAC,EAAE,KAAK,EAAE,KAAK,EAAE,MAAM,EAAE,CAAC,CAAC;IAEhF,MAAM,aAAa,GAAG,CAAC,KAA2F,EAAE,EAAE;QACpH,MAAM,EAAE,MAAM,EAAE,QAAQ,EAAE,GAAG,KAAK,CAAC;QAEnC,OAAO,CACL,oBAAC,WAAW,IACV,QAAQ,EAAE,GAAG,EAAE;gBACb,QAAQ,CAAC,MAAM,CAAC,CAAC;YACnB,CAAC;YAED,6BAAK,SAAS,EAAC,yDAAyD;gBACtE,6BAAK,SAAS,EAAC,iDAAiD;oBAC7D,iBAAiB,CAAC,MAAM,CAAC,OAAO,EAAE,SAAS,EAAE,IAAI,CAAC;oBAClD,MAAM,CAAC,SAAS,IAAI,iBAAiB,CAAC,MAAM,CAAC,SAAS,EAAE,WAAW,EAAE,IAAI,CAAC,CACvE;gBACN,oBAAC,QAAQ,IAAC,SAAS,EAAC,iCAAiC,GAAG,CACpD,CACM,CACf,CAAC;IACJ,CAAC,CAAC;IAEF,SAAS,4BAA4B,CAAC,KAAkC;QACtE,MAAM,CAAC,IAAI,EAAE,OAAO,CAAC,GAAG,QAAQ,CAAC,KAAK,CAAC,CAAC;QACxC,MAAM,EACJ,KAAK,EACL,MAAM,EACN,MAAM,EACN,WAAW,EACX,QAAQ,EACR,SAAS,EACT,UAAU,EACV,kBAAkB,EAClB,WAAW,EACX,gBAAgB,EAChB,qBAAqB,EACrB,cAAc,EACd,iBAAiB,EACjB,MAAM,EACN,cAAc,EACd,sBAAsB,EACtB,mBAAmB,EACnB,wBAAwB,EACxB,UAAU,GACX,GAAG,qBAAqB,CAAC,KAAK,CAAC,CAAC;QAEjC,MAAM,sBAAsB,GAAG,WAAW,CACxC,QAAQ,CAAC,GAAG,EAAE;YACZ,IAAI,iBAAiB,CAAC,WAAW,IAAI,mBAAmB,CAAC,MAAM,EAAE,CAAC;gBAChE,iBAAiB,CAAC,YAAY,EAAE,CAAC;YACnC,CAAC;QACH,CAAC,EAAE,GAAG,CAAC,EACP,CAAC,iBAAiB,EAAE,mBAAmB,CAAC,MAAM,CAAC,CAChD,CAAC;QAEF,OAAO,CACL,6BAAK,SAAS,EAAC,sBAAsB;YACnC,6BAAK,SAAS,EAAC,+BAA+B;gBAC5C,iCAAM,KAAK,CAAC,KAAK,IAAI,oBAAC,KAAK,QAAE,gBAAgB,CAAS,CAAO;gBAC7D;oBACE,oBAAC,OAAO,IAAC,IAAI,EAAE,IAAI,EAAE,YAAY,EAAE,OAAO;wBACxC,oBAAC,cAAc,IAAC,OAAO;4BACrB;gCACE,oBAAC,MAAM,IACL,IAAI,EAAC,QAAQ,EACb,OAAO,EAAC,SAAS,EACjB,IAAI,EAAC,UAAU,EACf,OAAO,EAAE,GAAG,EAAE,CAAC,OAAO,CAAC,CAAC,IAAI,CAAC,mBACd,IAAI,mBACJ,SAAS,EACxB,SAAS,EAAE,uEAAuE,IAAI,CAAC,CAAC,CAAC,WAAW,CAAC,CAAC,CAAC,EAAE,EAAE;oCAE3G,oBAAC,KAAK,IAAC,SAAS,EAAC,6CAA6C;;wCAAM,gBAAgB,IAAI,eAAe,CAAS;oCAChH,oBAAC,cAAc,IAAC,SAAS,EAAC,kCAAkC,GAAG,CACxD,CACL,CACS;wBACjB,oBAAC,cAAc,IAAC,SAAS,EAAC,6BAA6B;4BACrD,6BAAK,SAAS,EAAC,KAAK;gCAClB,oBAAC,gBAAgB,IACf,iBAAiB,EAAE,IAAI,EACvB,IAAI,EAAE,EAAE,EACR,SAAS,QACT,QAAQ,EAAE,QAAQ,EAClB,KAAK,EAAE,KAAK,EACZ,OAAO,EAAE,mBAAmB,EAC5B,QAAQ,EAAE,GAAG,EAAE,CAAC,KAAK,CAAC,EACtB,mBAAmB,EAAE,iBAAiB,CAAC,WAAW,IAAI,mBAAmB,CAAC,MAAM,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,KAAK,EAC/F,SAAS,EAAE,qBAAqB,EAChC,YAAY,EAAE,EAAE,EAChB,OAAO,EAAE,cAAc,EACvB,kBAAkB,EAAE,sBAAsB,EAC1C,QAAQ,EAAE,MAAM,CAAC,GAAG,EACpB,YAAY,EAAE,CAAC,MAAM,EAAE,EAAE,CAAC,CACxB,oBAAC,aAAa,IACZ,QAAQ,EAAE,CAAC,MAAM,EAAE,EAAE;4CACnB,MAAM,MAAM,GAAG,cAAc,EAAE,IAAI,CAAC,CAAC,MAAM,EAAE,EAAE,CAAC,MAAM,CAAC,EAAE,KAAK,MAAM,CAAC,EAAE,CAAC,IAAI,EAAE,EAAE,EAAE,MAAM,CAAC,EAAE,EAAE,CAAC;4CAC9F,MAAM,EAAE,SAAS,EAAE,UAAU,EAAE,SAAS,EAAE,UAAU,EAAE,GAAG,uBAAuB,EAAE,GAAG,MAAM,CAAC;4CAC5F,wBAAwB;gDACtB,MAAM,CAAC,EAAE,CAAC,wBAAwB,CAAC,EAAE,EAAE,GAAG,uBAAuB,EAAE,KAAK,EAAE,MAAM,CAAC,EAAE,EAAE,EAAE,CAAC,CAAC;wCAC7F,CAAC,EACD,MAAM,EAAE,MAAM,GACd,CACH,GACD,CACE,CACS,CACT,CACN,CACF;YACL,WAAW,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC,CAAC,CACxB,6BAAK,SAAS,EAAC,qBAAqB,IACjC,WAAW,CAAC,GAAG,CAAC,CAAC,CAAC,QAAQ,EAAE,GAAG,EAAE,MAAM,CAAC,EAAE,EAAE;gBAC3C,MAAM,aAAa,GAAG,wBAAwB,IAAI,MAAM,CAAC,wBAAwB,CAAC,CAAC;gBAEnF,MAAM,aAAa,GAAG,iBAAiB,CAAC,aAAa,EAAE;oBACrD,OAAO,EAAE,WAAW,CAAC,OAAO;oBAC5B,SAAS,EAAE,WAAW,CAAC,SAAS;oBAChC,QAAQ,EAAE,WAAW,CAAC,QAAQ;iBAC/B,CAAC,CAAC;gBAEH,OAAO,CACL,6BAAK,SAAS,EAAC,6CAA6C,EAAC,GAAG,EAAE,QAAQ;oBACxE,6BAAK,SAAS,EAAC,sBAAsB;wBACnC,6BAAK,SAAS,EAAC,YAAY;4BACzB,6BAAK,SAAS,EAAC,0CAA0C;gCACvD,6BAAK,SAAS,EAAC,eAAe;oCAC5B,6BAAK,SAAS,EAAC,yBAAyB;wCACrC,iBAAiB,CAAC,aAAa,CAAC,OAAO,EAAE,SAAS,CAAC;wCACnD,aAAa,EAAE,QAAQ,IAAI,iBAAiB,CAAC,aAAa,CAAC,QAAQ,EAAE,UAAU,CAAC,CAC7E;oCACL,aAAa,EAAE,SAAS,IAAI,iBAAiB,CAAC,aAAa,CAAC,SAAS,EAAE,WAAW,CAAC,CAChF;gCACN,oBAAC,MAAM,IACL,EAAE,EAAE,gBAAgB,UAAU,IAAI,GAAG,EAAE,EACvC,SAAS,EAAC,SAAS,EACnB,OAAO,EAAC,OAAO,EACf,IAAI,EAAC,QAAQ,EACb,IAAI,EAAC,MAAM,EACX,OAAO,EAAE,GAAG,EAAE,CAAC,MAAM,CAAC,GAAG,CAAC;oCAE1B,oBAAC,CAAC,IAAC,SAAS,EAAC,SAAS,GAAG,CAClB,CACL,CACF;wBACL,KAAK,CAAC,QAAQ,IAAI,CACjB,6BACE,SAAS,EAAC,qBAAqB,EAC/B,OAAO,EAAE,CAAC,CAAC,EAAE,EAAE;gCACb,CAAC,CAAC,eAAe,EAAE,CAAC;gCACpB,CAAC,CAAC,cAAc,EAAE,CAAC;4BACrB,CAAC;4BAED,oBAAC,mBAAmB,CAAC,QAAQ,IAC3B,KAAK,EAAE;oCACL,aAAa,EAAE,CAAC,IAAI,EAAE,EAAE,CAAC,GAAG,cAAc,IAAI,GAAG,IAAI,IAAI,CAAC,OAAO,CAAC,GAAG,sBAAsB,GAAG,EAAE,EAAE,CAAC,EAAE;oCACrG,qBAAqB,EAAE,CAAC,IAAI,EAAE,EAAE,CAAC,GAAG,cAAc,IAAI,IAAI,CAAC,OAAO,CAAC,GAAG,sBAAsB,GAAG,EAAE,EAAE,CAAC,EAAE;oCACtG,UAAU;oCACV,cAAc,EAAE,EAAE,sBAAsB,EAAE,wBAAwB,EAAE;iCACrE,IAEA,KAAK,CAAC,QAAQ,CACc,CAC3B,CACP,CACG,CACF,CACP,CAAC;YACJ,CAAC,CAAC,CACE,CACP,CAAC,CAAC,CAAC,CACF,6BAAK,SAAS,EAAC,6DAA6D;gBAC1E,oBAAC,KAAK,IAAC,SAAS,EAAC,uBAAuB;;oBAAK,gBAAgB;2BAAa,CACtE,CACP,CACG,CACP,CAAC;IACJ,CAAC;IAED,OAAO,oBAAoB,CAAC,4BAA4B,CAAC,CAAC;AAC5D,CAAC,CAAC","sourcesContent":["import { ChevronsUpDown, PlusIcon, X } from \"lucide-react\";\nimport React, { useCallback, useState } from \"react\";\nimport { useHasManyThroughForm } from \"../../../../useHasManyThroughForm.js\";\nimport { debounce } from \"../../../../utils.js\";\nimport { autoRelationshipForm } from \"../../../AutoInput.js\";\nimport { RelationshipContext } from \"../../../hooks/useAutoRelationship.js\";\nimport { getRecordAsOption } from \"../../../hooks/useRelatedModel.js\";\nimport type { AutoHasManyThroughFormProps, DisplayedRecordOption } from \"../../../interfaces/AutoRelationshipInputProps.js\";\nimport type { ShadcnElements } from \"../../elements.js\";\nimport { makeShadcnRenderOptionLabel } from \"../../utils.js\";\nimport { makeShadcnAutoComboInput } from \"../ShadcnAutoComboInput.js\";\n\nexport const makeShadcnAutoHasManyThroughForm = ({\n  Badge,\n  Button,\n  Label,\n  Command,\n  CommandInput,\n  CommandItem,\n  CommandList,\n  CommandEmpty,\n  CommandGroup,\n  Checkbox,\n  Popover,\n  PopoverContent,\n  PopoverTrigger,\n}: Pick<\n  ShadcnElements,\n  | \"Badge\"\n  | \"Button\"\n  | \"Label\"\n  | \"Command\"\n  | \"CommandInput\"\n  | \"CommandItem\"\n  | \"CommandList\"\n  | \"CommandEmpty\"\n  | \"CommandGroup\"\n  | \"Checkbox\"\n  | \"Popover\"\n  | \"PopoverContent\"\n  | \"PopoverTrigger\"\n>) => {\n  const ShadcnComboInput = makeShadcnAutoComboInput({\n    Command,\n    CommandInput,\n    Label,\n    CommandItem,\n    CommandList,\n    CommandEmpty,\n    CommandGroup,\n    Checkbox,\n  });\n\n  const renderOptionLabel = makeShadcnRenderOptionLabel({ Label, Badge, Button });\n\n  const SiblingOption = (props: { option: DisplayedRecordOption; onSelect: (option: DisplayedRecordOption) => void }) => {\n    const { option, onSelect } = props;\n\n    return (\n      <CommandItem\n        onSelect={() => {\n          onSelect(option);\n        }}\n      >\n        <div className=\"flex justify-between items-center w-full cursor-pointer\">\n          <div className=\"flex flex-row items-center gap-2 cursor-pointer\">\n            {renderOptionLabel(option.primary, \"primary\", true)}\n            {option.secondary && renderOptionLabel(option.secondary, \"secondary\", true)}\n          </div>\n          <PlusIcon className=\"w-4 h-4 shrink-0 cursor-pointer\" />\n        </div>\n      </CommandItem>\n    );\n  };\n\n  function ShadcnAutoHasManyThroughForm(props: AutoHasManyThroughFormProps) {\n    const [open, setOpen] = useState(false);\n    const {\n      field,\n      append,\n      remove,\n      joinRecords,\n      metadata,\n      listboxId,\n      pathPrefix,\n      metaDataPathPrefix,\n      recordLabel,\n      siblingModelName,\n      siblingRecordsLoading,\n      siblingRecords,\n      siblingPagination,\n      search,\n      joinModelField,\n      joinModelApiIdentifier,\n      siblingModelOptions,\n      inverseRelatedModelField,\n      fieldArray,\n    } = useHasManyThroughForm(props);\n\n    const handleScrolledToBottom = useCallback(\n      debounce(() => {\n        if (siblingPagination.hasNextPage && siblingModelOptions.length) {\n          siblingPagination.loadNextPage();\n        }\n      }, 300),\n      [siblingPagination, siblingModelOptions.length]\n    );\n\n    return (\n      <div className=\"flex flex-col gap-2 \">\n        <div className=\"flex justify-between flex-row\">\n          <div>{props.label ?? <Label>{siblingModelName}</Label>}</div>\n          <div>\n            <Popover open={open} onOpenChange={setOpen}>\n              <PopoverTrigger asChild>\n                <div>\n                  <Button\n                    type=\"button\"\n                    variant=\"outline\"\n                    role=\"combobox\"\n                    onClick={() => setOpen(!open)}\n                    aria-expanded={open}\n                    aria-controls={listboxId}\n                    className={`w-[300px] flex flex-row items-center justify-between cursor-pointer ${open ? \"bg-accent\" : \"\"}`}\n                  >\n                    <Label className=\"truncate flex-grow text-left cursor-pointer\">Add {siblingModelName ?? \"related model\"}</Label>\n                    <ChevronsUpDown className=\"opacity-50 w-5 h-5 flex-shrink-0\" />\n                  </Button>\n                </div>\n              </PopoverTrigger>\n              <PopoverContent className=\"w-[300px] bg-background p-0\">\n                <div className=\"p-2\">\n                  <ShadcnComboInput\n                    selectedRecordTag={null}\n                    path={\"\"}\n                    hideLabel\n                    metadata={metadata}\n                    field={field}\n                    options={siblingModelOptions}\n                    onSelect={() => void 0}\n                    willLoadMoreOptions={siblingPagination.hasNextPage && siblingModelOptions.length ? true : false}\n                    isLoading={siblingRecordsLoading}\n                    errorMessage={\"\"}\n                    records={siblingRecords}\n                    onScrolledToBottom={handleScrolledToBottom}\n                    onChange={search.set}\n                    renderOption={(option) => (\n                      <SiblingOption\n                        onSelect={(option) => {\n                          const record = siblingRecords?.find((record) => record.id === option.id) ?? { id: option.id };\n                          const { createdAt: _createdAt, updatedAt: _updatedAt, ...recordWithoutTimestamps } = record;\n                          inverseRelatedModelField &&\n                            append({ [inverseRelatedModelField]: { ...recordWithoutTimestamps, _link: record.id } });\n                        }}\n                        option={option}\n                      />\n                    )}\n                  />\n                </div>\n              </PopoverContent>\n            </Popover>\n          </div>\n        </div>\n        {joinRecords.length > 0 ? (\n          <div className=\"flex flex-col gap-3\">\n            {joinRecords.map(([fieldKey, idx, record]) => {\n              const siblingRecord = inverseRelatedModelField && record[inverseRelatedModelField];\n\n              const siblingOption = getRecordAsOption(siblingRecord, {\n                primary: recordLabel.primary,\n                secondary: recordLabel.secondary,\n                tertiary: recordLabel.tertiary,\n              });\n\n              return (\n                <div className=\"flex items-center w-full border rounded-md \" key={fieldKey}>\n                  <div className=\"flex flex-col w-full\">\n                    <div className=\"flex-1 p-2\">\n                      <div className=\"flex justify-between items-center w-full\">\n                        <div className=\"flex flex-col\">\n                          <div className=\"flex items-center gap-2\">\n                            {renderOptionLabel(siblingOption.primary, \"primary\")}\n                            {siblingOption?.tertiary && renderOptionLabel(siblingOption.tertiary, \"tertiary\")}\n                          </div>\n                          {siblingOption?.secondary && renderOptionLabel(siblingOption.secondary, \"secondary\")}\n                        </div>\n                        <Button\n                          id={`deleteButton_${pathPrefix}.${idx}`}\n                          className=\"ml-auto\"\n                          variant=\"ghost\"\n                          type=\"button\"\n                          size=\"icon\"\n                          onClick={() => remove(idx)}\n                        >\n                          <X className=\"w-4 h-4\" />\n                        </Button>\n                      </div>\n                    </div>\n                    {props.children && (\n                      <div\n                        className=\"flex-1 p-2 border-t\"\n                        onClick={(e) => {\n                          e.stopPropagation();\n                          e.preventDefault();\n                        }}\n                      >\n                        <RelationshipContext.Provider\n                          value={{\n                            transformPath: (path) => `${joinModelField}.${idx}.${path.replace(`${joinModelApiIdentifier}.`, \"\")}`,\n                            transformMetadataPath: (path) => `${joinModelField}.${path.replace(`${joinModelApiIdentifier}.`, \"\")}`,\n                            fieldArray,\n                            hasManyThrough: { joinModelApiIdentifier, inverseRelatedModelField },\n                          }}\n                        >\n                          {props.children}\n                        </RelationshipContext.Provider>\n                      </div>\n                    )}\n                  </div>\n                </div>\n              );\n            })}\n          </div>\n        ) : (\n          <div className=\"flex items-center justify-center border rounded-md p-2 mt-4\">\n            <Label className=\"text-sm text-gray-500\">No {siblingModelName} yet</Label>\n          </div>\n        )}\n      </div>\n    );\n  }\n\n  return autoRelationshipForm(ShadcnAutoHasManyThroughForm);\n};\n"]}