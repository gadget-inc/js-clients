{"version":3,"file":"metadata.js","sourceRoot":"","sources":["../../src/metadata.tsx"],"names":[],"mappings":"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","sourcesContent":["import type { ActionFunction, AnyClient, GlobalActionFunction } from \"@gadgetinc/api-client-core\";\nimport { assert } from \"@gadgetinc/api-client-core\";\nimport type { ResultOf } from \"@graphql-typed-document-node/core\";\nimport { DocumentNode } from \"graphql\";\nimport { useApi } from \"./GadgetProvider.js\";\nimport { graphql } from \"./internal/gql/gql.js\";\nimport { GadgetFieldType } from \"./internal/gql/graphql.js\";\nimport { useGadgetQuery } from \"./useGadgetQuery.js\";\nimport { ErrorWrapper, getModelManager } from \"./utils.js\";\n\n/**\n * The enum of all possible field types in Gadget's type system\n * @internal\n */\nexport const FieldType = GadgetFieldType;\n\ntype WithRequired<T, K extends keyof T> = T & { [P in K]-?: Exclude<T[P], null> };\ntype Clarify<T> = T extends Record<string, unknown> ? { [Key in keyof T]: T[Key] } : T;\n\nconst FieldMetadataFragment = graphql(/* GraphQL */ `\n  fragment FieldMetadata on GadgetField {\n    name\n    apiIdentifier\n    fieldType\n    requiredArgumentForInput\n    ... on GadgetModelField {\n      sortable\n      filterable\n    }\n    configuration {\n      __typename\n      fieldType\n      validations {\n        __typename\n        ... on GadgetRegexFieldValidation {\n          name\n          specID\n          pattern\n        }\n        ... on GadgetRangeFieldValidation {\n          name\n          specID\n          min\n          max\n        }\n        ... on GadgetOnlyImageFileFieldValidation {\n          name\n          specID\n          allowAnimatedImages\n        }\n        ... on GadgetGenericFieldValidation {\n          name\n          specID\n        }\n      }\n      ... on GadgetHasManyConfig {\n        relatedModel {\n          apiIdentifier\n          namespace\n        }\n        inverseField {\n          apiIdentifier\n        }\n      }\n      ... on GadgetHasOneConfig {\n        relatedModel {\n          apiIdentifier\n          namespace\n        }\n        inverseField {\n          apiIdentifier\n        }\n      }\n      ... on GadgetBelongsToConfig {\n        relatedModel {\n          apiIdentifier\n          namespace\n        }\n      }\n      ... on GadgetEnumConfig {\n        allowMultiple\n        allowOther\n        options {\n          name\n          color\n        }\n      }\n      ... on GadgetDateTimeConfig {\n        includeTime\n      }\n    }\n  }\n`);\n\nconst ModelMetadataQuery = graphql(/* GraphQL */ `\n  query GetModelMetadata($apiIdentifier: String!, $namespace: [String!]) {\n    gadgetMeta {\n      model(apiIdentifier: $apiIdentifier, namespace: $namespace) {\n        apiIdentifier\n        namespace\n        name\n        fields {\n          ...FieldMetadata\n        }\n      }\n    }\n  }\n`);\n\nconst _SubFieldsFragment = graphql(/* GraphQL */ `\n  fragment SubFields on GadgetField {\n    configuration {\n      __typename\n      ... on GadgetObjectFieldConfig {\n        name\n        fields {\n          ...FieldMetadata\n          configuration {\n            __typename\n            ... on GadgetObjectFieldConfig {\n              name\n              fields {\n                ...FieldMetadata\n                configuration {\n                  __typename\n                  ... on GadgetObjectFieldConfig {\n                    name\n                    fields {\n                      ...FieldMetadata\n                    }\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n`);\n\nconst ModelActionMetadataQuery = graphql(/* GraphQL */ `\n  query ModelActionMetadata($modelApiIdentifier: String!, $modelNamespace: [String!], $action: String!) {\n    gadgetMeta {\n      model(apiIdentifier: $modelApiIdentifier, namespace: $modelNamespace) {\n        name\n        apiIdentifier\n        defaultRecord\n        action(apiIdentifier: $action) {\n          name\n          apiIdentifier\n          operatesWithRecordIdentity\n          inputFields {\n            ...FieldMetadata\n            ...SubFields\n          }\n        }\n      }\n    }\n  }\n`);\n\nconst GlobalActionMetadataQuery = graphql(/* GraphQL */ `\n  query GlobalActionMetadata($apiIdentifier: String!, $namespace: [String!]) {\n    gadgetMeta {\n      globalAction(apiIdentifier: $apiIdentifier, namespace: $namespace) {\n        name\n        apiIdentifier\n        inputFields {\n          ...FieldMetadata\n          ...SubFields\n        }\n      }\n    }\n  }\n`);\n\nconst RolesMetadataQuery = graphql(/* GraphQL */ `\n  query RolesMetadata {\n    gadgetMeta {\n      roles {\n        name\n        key\n        selectable\n      }\n    }\n  }\n`);\n\nexport type ModelMetadata = Exclude<ResultOf<typeof ModelMetadataQuery>[\"gadgetMeta\"][\"model\"], null | undefined>;\nexport type ActionMetadata = Clarify<\n  WithRequired<Exclude<ResultOf<typeof ModelActionMetadataQuery>[\"gadgetMeta\"][\"model\"], null | undefined>, \"action\">\n>;\nexport type GlobalActionMetadata = Clarify<\n  Exclude<ResultOf<typeof GlobalActionMetadataQuery>[\"gadgetMeta\"][\"globalAction\"], null | undefined>\n>;\n\nexport type FieldMetadata = ResultOf<typeof FieldMetadataFragment>;\n\n/**\n * Retrieve a given Gadget model's metadata from the backend\n * @internal\n */\nexport const useModelMetadata = (apiIdentifier: string, namespace: string[]) => {\n  const [{ data, fetching, error }] = useGadgetQuery({\n    query: ModelMetadataQuery,\n    variables: { apiIdentifier, namespace },\n  });\n\n  return {\n    metadata: data ? assert(data.gadgetMeta.model, \"no model metadata found from Gadget API\") : data,\n    fetching,\n    error: error ? ErrorWrapper.forClientSideError(error) : undefined,\n  };\n};\n\nconst getGlobalActionApiIdentifier = (api: AnyClient, fn: GlobalActionFunction<any>) => {\n  let cursor: any = api;\n  if (fn.namespace) {\n    for (const segment of Array.isArray(fn.namespace) ? fn.namespace : [fn.namespace]) {\n      cursor = cursor[segment];\n    }\n  }\n  for (const [key, value] of Object.entries(cursor)) {\n    if (value === fn) {\n      return key;\n    }\n  }\n  throw new Error(\"global action function not found on model manager\");\n};\n\n/**\n * Retrieve a given Gadget model action's metadata from the backend\n * @internal\n */\nexport const useActionMetadata = (actionFunction: ActionFunction<any, any, any, any, any> | GlobalActionFunction<any>) => {\n  const api = useApi();\n\n  let query: DocumentNode;\n  let variables: Record<string, any>;\n\n  if (actionFunction.type === \"globalAction\") {\n    query = GlobalActionMetadataQuery;\n    variables = {\n      apiIdentifier: getGlobalActionApiIdentifier(api, actionFunction),\n      namespace: actionFunction.namespace,\n    };\n  } else {\n    query = ModelActionMetadataQuery;\n    const modelManager = assert(\n      getModelManager(api, actionFunction.modelApiIdentifier, actionFunction.namespace),\n      \"no model manager found for action function\"\n    );\n    let actionName;\n    const proto = Object.getPrototypeOf(modelManager);\n    for (const [key, value] of Object.entries(proto)) {\n      if (value === actionFunction) {\n        actionName = key;\n        break;\n      }\n    }\n    if (!actionName) {\n      throw new Error(\"action function not found on model manager\");\n    }\n    variables = {\n      modelApiIdentifier: actionFunction.modelApiIdentifier,\n      modelNamespace: actionFunction.namespace,\n      action: actionName,\n    };\n  }\n\n  const [{ data, fetching, error }] = useGadgetQuery({\n    query,\n    variables,\n  });\n\n  let metadata: ActionMetadata | GlobalActionMetadata | undefined = undefined;\n\n  if (data) {\n    if (actionFunction.type === \"globalAction\") {\n      metadata = assert(data.gadgetMeta.globalAction, \"no global action metadata found from Gadget API\");\n    } else {\n      metadata = data.gadgetMeta.model as ActionMetadata;\n      assert(metadata?.action, \"no model metadata found from Gadget API\");\n    }\n  }\n\n  return {\n    metadata,\n    fetching,\n    error: error ? ErrorWrapper.forClientSideError(error) : undefined,\n  };\n};\n\n/**\n * @internal\n */\nexport const filterFieldList = (\n  fields: FieldMetadata[] | undefined,\n  options?: { include?: string[]; exclude?: string[] }\n): FieldMetadata[] => {\n  if (!fields) {\n    return [];\n  }\n\n  let subset = fields;\n\n  if (options?.include) {\n    // When including fields, the order will match the order of the `include` array\n    subset = [];\n    const includes = new Set(options.include);\n\n    for (const includedFieldApiId of Array.from(includes)) {\n      const metadataField = fields.find((field) => field.apiIdentifier === includedFieldApiId);\n      if (metadataField) {\n        subset.push(metadataField);\n      }\n    }\n  }\n\n  if (options?.exclude) {\n    const excludes = new Set(options.exclude);\n    if (options?.include && options.include.some((fieldApiId) => excludes.has(fieldApiId))) {\n      throw new Error(\"Cannot include and exclude the same field\");\n    }\n\n    subset = subset.filter((field) => !excludes.has(field.apiIdentifier));\n  }\n\n  // Filter out fields that are not supported by the form\n  return subset.filter((field) => acceptedFieldTypes.has(field.fieldType));\n};\n\nconst acceptedFieldTypes = new Set([\n  FieldType.Boolean,\n  FieldType.Color,\n  FieldType.Computed, // Not rendered as an input\n  FieldType.DateTime,\n  FieldType.Email,\n  FieldType.EncryptedString,\n  FieldType.Enum,\n  FieldType.File,\n  FieldType.Json,\n  FieldType.Number,\n  FieldType.Password,\n  FieldType.RichText,\n  FieldType.RoleAssignments,\n  FieldType.String,\n  FieldType.Url,\n  FieldType.Vector, // Not rendered as an input\n\n  // Relationships\n  FieldType.BelongsTo,\n  FieldType.HasMany,\n  FieldType.HasOne,\n]);\n\n/**\n * Retrieve the roles available in the Gadget app from the backend\n * @internal\n */\nexport const useRolesMetadata = () => {\n  const [{ data, fetching, error }] = useGadgetQuery({\n    query: RolesMetadataQuery,\n  });\n\n  return {\n    roles: data?.gadgetMeta.roles,\n    fetching,\n    error: error ? ErrorWrapper.forClientSideError(error) : undefined,\n  };\n};\n\nexport const isActionMetadata = (metadata: ActionMetadata | GlobalActionMetadata): metadata is ActionMetadata => {\n  return \"action\" in metadata;\n};\n"]}