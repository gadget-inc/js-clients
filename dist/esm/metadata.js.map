{"version":3,"file":"metadata.js","sourceRoot":"","sources":["../../src/metadata.tsx"],"names":[],"mappings":"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","sourcesContent":["import type { ActionFunction, AnyModelManager } from \"@gadgetinc/api-client-core\";\nimport { assert } from \"@gadgetinc/api-client-core\";\nimport type { ResultOf } from \"@graphql-typed-document-node/core\";\nimport { useApi } from \"./GadgetProvider\";\nimport { graphql } from \"./internal/gql\";\nimport { GadgetFieldType } from \"./internal/gql/graphql\";\nimport { useGadgetQuery } from \"./useGadgetQuery\";\nimport { ErrorWrapper } from \"./utils\";\n\n/**\n * The enum of all possible field types in Gadget's type system\n * @internal\n */\nexport const FieldType = GadgetFieldType;\n\ntype WithRequired<T, K extends keyof T> = T & { [P in K]-?: Exclude<T[P], null> };\ntype Clarify<T> = T extends Record<string, unknown> ? { [Key in keyof T]: T[Key] } : T;\n\nconst FieldMetadataFragment = graphql(/* GraphQL */ `\n  fragment FieldMetadata on GadgetField {\n    name\n    apiIdentifier\n    fieldType\n    requiredArgumentForInput\n    ... on GadgetModelField {\n      sortable\n      filterable\n    }\n    configuration {\n      __typename\n      fieldType\n      ... on GadgetHasManyConfig {\n        relatedModel {\n          apiIdentifier\n        }\n      }\n      ... on GadgetBelongsToConfig {\n        relatedModel {\n          apiIdentifier\n        }\n      }\n      ... on GadgetEnumConfig {\n        allowMultiple\n        options {\n          name\n          color\n        }\n      }\n    }\n  }\n`);\n\nconst ModelMetadataQuery = graphql(/* GraphQL */ `\n  query GetModelMetadata($apiIdentifier: String!) {\n    gadgetMeta {\n      model(apiIdentifier: $apiIdentifier) {\n        apiIdentifier\n        name\n        fields {\n          ...FieldMetadata\n        }\n      }\n    }\n  }\n`);\n\nconst _SubFieldsFragment = graphql(/* GraphQL */ `\n  fragment SubFields on GadgetField {\n    configuration {\n      __typename\n      ... on GadgetObjectFieldConfig {\n        name\n        fields {\n          ...FieldMetadata\n          configuration {\n            __typename\n            ... on GadgetObjectFieldConfig {\n              name\n              fields {\n                ...FieldMetadata\n                configuration {\n                  __typename\n                  ... on GadgetObjectFieldConfig {\n                    name\n                    fields {\n                      ...FieldMetadata\n                    }\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n`);\n\nconst ModelActionMetadataQuery = graphql(/* GraphQL */ `\n  query ModelActionMetadata($model: String!, $action: String!) {\n    gadgetMeta {\n      model(apiIdentifier: $model) {\n        name\n        action(apiIdentifier: $action) {\n          name\n          apiIdentifier\n          inputFields {\n            ...FieldMetadata\n            ...SubFields\n          }\n        }\n      }\n    }\n  }\n`);\n\nconst RolesMetadataQuery = graphql(/* GraphQL */ `\n  query RolesMetadata {\n    gadgetMeta {\n      roles {\n        name\n        selectable\n      }\n    }\n  }\n`);\n\nexport type ModelMetadata = Exclude<ResultOf<typeof ModelMetadataQuery>[\"gadgetMeta\"][\"model\"], null | undefined>;\nexport type ActionMetadata = Clarify<\n  WithRequired<Exclude<ResultOf<typeof ModelActionMetadataQuery>[\"gadgetMeta\"][\"model\"], null | undefined>, \"action\">\n>;\n\nexport type FieldMetadata = ResultOf<typeof FieldMetadataFragment>;\n\n/**\n * Retrieve a given Gadget model's metadata from the backend\n * @internal\n */\nexport const useModelMetadata = (apiIdentifier: string) => {\n  const [{ data, fetching, error }] = useGadgetQuery({\n    query: ModelMetadataQuery,\n    variables: { apiIdentifier },\n  });\n\n  return {\n    metadata: data ? assert(data.gadgetMeta.model, \"no model metadata found from Gadget API\") : data,\n    fetching,\n    error: error ? ErrorWrapper.forClientSideError(error) : undefined,\n  };\n};\n\n/**\n * Retrieve a given Gadget model's metadata from the backend\n * @internal\n */\nexport const useActionMetadata = (actionFunction: ActionFunction<any, any, any, any, any>) => {\n  const api = useApi();\n  const modelManager = assert(\n    (api as any)[actionFunction.modelApiIdentifier] as AnyModelManager,\n    \"no model manager found for action function\"\n  );\n  let actionName;\n  for (const [key, value] of Object.entries(modelManager)) {\n    if (value === actionFunction) {\n      actionName = key;\n      break;\n    }\n  }\n  if (!actionName) {\n    throw new Error(\"action function not found on model manager\");\n  }\n\n  const [{ data, fetching, error }] = useGadgetQuery({\n    query: ModelActionMetadataQuery,\n    variables: { model: actionFunction.modelApiIdentifier, action: actionName },\n  });\n\n  if (data) {\n    assert(data.gadgetMeta.model?.action, \"no model metadata found from Gadget API\");\n  }\n\n  return {\n    metadata: data ? (data.gadgetMeta.model as ActionMetadata) : data,\n    fetching,\n    error: error ? ErrorWrapper.forClientSideError(error) : undefined,\n  };\n};\n\n/**\n * @internal\n */\nexport const filterFieldList = (\n  fields: FieldMetadata[] | undefined,\n  options?: { include?: string[]; exclude?: string[]; fields?: string[]; select?: Record<string, any> }\n): FieldMetadata[] => {\n  if (!fields) {\n    return [];\n  }\n  let subset = fields;\n  if (options?.fields) {\n    return options.fields.map((apiIdentifier) => {\n      const field = fields.find((field) => field.apiIdentifier === apiIdentifier);\n      if (!field) throw new Error(`form trying to include field ${apiIdentifier} that doesn't exist on the model`);\n      return field;\n    });\n  }\n  if (options?.include) {\n    const includes = new Set(options.include);\n    subset = subset.filter((field) => includes.has(field.apiIdentifier));\n  }\n  if (options?.select) {\n    const includes = new Set(Object.keys(options.select).filter((key) => options.select![key]));\n    subset = subset.filter((field) => includes.has(field.apiIdentifier));\n  }\n  if (options?.exclude) {\n    const excludes = new Set(options.exclude);\n    subset = subset.filter((field) => !excludes.has(field.apiIdentifier));\n  }\n\n  // if no explicit selection has been given, filter down to the field types we know we have support for\n  const explicitSet = options?.fields ?? options?.include ?? options?.exclude ?? options?.select;\n  if (!explicitSet) {\n    subset = subset.filter((field) => {\n      switch (field.fieldType) {\n        case FieldType.String:\n        case FieldType.Number:\n        case FieldType.Email:\n        case FieldType.Password:\n        case FieldType.EncryptedString:\n        case FieldType.Color:\n        case FieldType.Url:\n        case FieldType.Boolean:\n        case FieldType.DateTime:\n        case FieldType.Json:\n        case FieldType.Enum:\n        case FieldType.File:\n        case FieldType.RoleAssignments:\n          return true;\n        default:\n          return false;\n      }\n    });\n  }\n\n  return subset;\n};\n\n/**\n * Retrieve the roles available in the Gadget app from the backend\n * @internal\n */\nexport const useRolesMetadata = () => {\n  const [{ data, fetching, error }] = useGadgetQuery({\n    query: RolesMetadataQuery,\n  });\n\n  return {\n    roles: data?.gadgetMeta.roles,\n    fetching,\n    error: error ? ErrorWrapper.forClientSideError(error) : undefined,\n  };\n};\n"]}