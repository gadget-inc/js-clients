{"version":3,"file":"useHasManyThroughForm.js","sourceRoot":"","sources":["../../src/useHasManyThroughForm.ts"],"names":[],"mappings":"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","sourcesContent":["import { assert } from \"@gadgetinc/client-hooks\";\nimport { useEffect, useMemo } from \"react\";\nimport { useAutoRelationship, useRelationshipContext } from \"./auto/hooks/useAutoRelationship.js\";\nimport { useHasManyThroughController } from \"./auto/hooks/useHasManyThroughController.js\";\nimport { useRecordLabelObjectFromProps } from \"./auto/hooks/useRelatedModel.js\";\nimport type { AutoHasManyThroughFormProps } from \"./auto/interfaces/AutoRelationshipInputProps.js\";\nimport { useFormContext } from \"./useActionForm.js\";\n\nexport const useHasManyThroughForm = (props: AutoHasManyThroughFormProps) => {\n  const { field, children, allowMultipleSelections } = props;\n  const { metadata } = useAutoRelationship({ field });\n  const { setValue } = useFormContext();\n\n  const { fieldArrayPath, fieldArray, records, relatedModelOptions, inverseRelatedModelField, joinModelField, joinModelApiIdentifier } =\n    useHasManyThroughController(props);\n\n  const { fields, append, remove } = fieldArray;\n  const relationshipContext = useRelationshipContext();\n  const pathPrefix = relationshipContext?.transformPath ? relationshipContext.transformPath(props.field) : props.field;\n  const metaDataPathPrefix = relationshipContext?.transformMetadataPath\n    ? relationshipContext.transformMetadataPath(props.field)\n    : pathPrefix;\n\n  useEffect(() => {\n    for (const [index, field] of fields.entries()) {\n      if (\n        inverseRelatedModelField &&\n        (field as any)[inverseRelatedModelField] &&\n        (field as any)[inverseRelatedModelField].id &&\n        !(\"_link\" in field)\n      ) {\n        // use setValue so that we don't trigger a re-render\n        setValue(`${fieldArrayPath}.${index}.${inverseRelatedModelField}._link`, (field as any)[inverseRelatedModelField].id);\n      }\n    }\n  }, [setValue, inverseRelatedModelField, fields, fieldArrayPath]);\n\n  const listboxId = `HasManyThroughListboxInPopover-${field}`;\n\n  if (metadata?.configuration.__typename !== \"GadgetHasManyThroughConfig\") {\n    throw new Error(\"AutoHasManyThroughForm can only be used for HasManyThrough fields\");\n  }\n\n  const {\n    search,\n    searchFilterOptions: rawSiblingModelOptions,\n    relatedModel: { fetching: siblingRecordsLoading, records: siblingRecords },\n    pagination: siblingPagination,\n  } = relatedModelOptions;\n  const siblingModelName = metadata.name ?? \"Unknown\";\n\n  const joinRecords = useMemo(() => {\n    return fields.flatMap((field, idx): [string, number, Record<string, any>][] => {\n      const record = records[idx];\n\n      if (\n        !record ||\n        !inverseRelatedModelField ||\n        !record[inverseRelatedModelField] // Do not consider join records that are not connected to a sibling model record\n      ) {\n        return [];\n      }\n\n      return [[field._fieldArrayKey, idx, record]];\n    });\n  }, [fields, records, inverseRelatedModelField]);\n\n  const recordLabel = useRecordLabelObjectFromProps(props);\n\n  const siblingModelOptions = useMemo(() => {\n    if (!allowMultipleSelections && inverseRelatedModelField) {\n      return rawSiblingModelOptions.filter(\n        (option) =>\n          !joinRecords.some((joinRecord) => {\n            const rawJoinRecord = joinRecord[2];\n            const siblingFromJoinRecord = rawJoinRecord[inverseRelatedModelField];\n            return siblingFromJoinRecord && \"id\" in siblingFromJoinRecord && siblingFromJoinRecord.id === option.id;\n          })\n      );\n    }\n    return rawSiblingModelOptions;\n  }, [rawSiblingModelOptions, allowMultipleSelections, inverseRelatedModelField, joinRecords]);\n\n  return {\n    fields,\n    append,\n    remove,\n    joinRecords,\n    listboxId,\n    pathPrefix,\n    metaDataPathPrefix,\n    recordLabel,\n    siblingModelName,\n    siblingRecordsLoading,\n    siblingRecords,\n    siblingPagination,\n    search,\n    siblingModelOptions,\n    metadata,\n    joinModelField,\n    joinModelApiIdentifier: assert(joinModelApiIdentifier, `The join model in the \"${field}\" hasManyThrough field is required`),\n    inverseRelatedModelField: assert(\n      inverseRelatedModelField,\n      `The belongsTo field between the join model and sibling model in the \"${field}\" hasManyThrough field is required`\n    ),\n    fieldArrayPath,\n    fieldArray,\n    field,\n    records,\n    children,\n    relatedModelOptions,\n  };\n};\n"]}