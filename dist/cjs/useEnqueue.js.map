{"version":3,"file":"useEnqueue.js","sourceRoot":"","sources":["../../src/useEnqueue.ts"],"names":[],"mappings":"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","sourcesContent":["import type { ActionFunctionMetadata, EnqueueBackgroundActionOptions, GadgetConnection } from \"@gadgetinc/api-client-core\";\nimport {\n  BackgroundActionHandle,\n  disambiguateActionVariables,\n  disambiguateBulkActionVariables,\n  enqueueActionOperation,\n  get,\n  graphqlizeBackgroundOptions,\n  namespaceDataPath,\n} from \"@gadgetinc/api-client-core\";\nimport type { AnyActionFunction } from \"@gadgetinc/api-client-core/src/GadgetFunctions.js\";\nimport { useCallback, useContext, useMemo } from \"react\";\nimport type { UseMutationState } from \"urql\";\nimport { GadgetUrqlClientContext, useConnection } from \"./GadgetProvider.js\";\nimport { useGadgetMutation } from \"./useGadgetMutation.js\";\nimport type { EnqueueHookResult, EnqueueHookState } from \"./utils.js\";\nimport { ErrorWrapper, noProviderErrorMessage } from \"./utils.js\";\n\n/**\n * React hook to enqueue a Gadget action in the background. `useEnqueue` must be passed an action function from an instance of your generated API client library, like `useEnqueue(api.user.create)` or `useEnqueue(api.someGlobalAction)`. `useEnqueue` doesn't actually submit the background action when invoked, but instead returns a function for enqueuing the action in response to an event.\n *\n * @param action a model action or global action in your application's client, like `api.user.create` or `api.someGlobalAction`\n * @param options action options, like selecting the fields in the result\n *\n * @example\n * export function CreateUserButton(props: { name: string; email: string }) {\n *   const [{error, fetching, handle}, enqueue] = useEnqueue(api.user.create));\n *\n *   const onClick = () => enqueue(\n *     {\n *       name: props.name,\n *       email: props.email,\n *     }, {\n *       id: `send-email-action-${props.email}`\n *     }\n *   );\n *\n *   return (\n *     <>\n *       {error && <>Failed to enqueue user create: {error.toString()}</>}\n *       {fetching && <>Enqueuing action...</>}\n *       {data && <>Enqueued action with background action id={handle.id}</>}\n *       <button onClick={onClick}>Create user</button>\n *     </>\n *   );\n * }\n */\nexport const useEnqueue = <Action extends AnyActionFunction>(\n  action: Action,\n  baseBackgroundOptions?: EnqueueBackgroundActionOptions<Action>\n): EnqueueHookResult<Action> => {\n  if (!useContext(GadgetUrqlClientContext)) throw new Error(noProviderErrorMessage);\n\n  const plan = useMemo(\n    () => enqueueActionOperation(action.operationName, action.variables, action.namespace, null, action.isBulk),\n    [action]\n  );\n  const connection = useConnection();\n\n  const [rawState, runMutation] = useGadgetMutation(plan.query);\n\n  const state: EnqueueHookState<Action> = useMemo(() => processResult(connection, rawState, action), [rawState, action]);\n\n  return [\n    state,\n    useCallback(\n      async (input: Action[\"variablesType\"], options?: EnqueueBackgroundActionOptions<Action>) => {\n        const variables = action.isBulk\n          ? disambiguateBulkActionVariables(action as ActionFunctionMetadata<any, any, any, any, any, true>, input)\n          : disambiguateActionVariables(action, input);\n\n        const fullContext = { ...baseBackgroundOptions, ...options };\n        variables.backgroundOptions = graphqlizeBackgroundOptions(fullContext);\n\n        const rawState = await runMutation(variables, fullContext);\n\n        return processResult(connection, { fetching: false, ...rawState }, action);\n      },\n      [action, connection, runMutation]\n    ),\n  ];\n};\n\n/** Processes urql's result object into the fancier Gadget result object */\nconst processResult = <Action extends AnyActionFunction>(\n  connection: GadgetConnection,\n  rawResult: UseMutationState<any, any>,\n  action: Action\n): EnqueueHookState<Action> => {\n  const { data, ...result } = rawResult;\n  let error = ErrorWrapper.forMaybeCombinedError(result.error);\n  let handle: BackgroundActionHandle<Action> | null = null;\n  let handles: BackgroundActionHandle<Action>[] | null = null;\n  const isBulk = action.isBulk;\n\n  if (data) {\n    const dataPath = [\"background\", ...namespaceDataPath([action.operationName], action.namespace)];\n\n    const mutationData = get(data, dataPath);\n    if (mutationData) {\n      const errors = mutationData[\"errors\"];\n      if (errors && errors[0]) {\n        error = ErrorWrapper.forErrorsResponse(errors, error?.response);\n      } else {\n        if (isBulk) {\n          handles = mutationData.backgroundActions.map(\n            (result: { id: string }) => new BackgroundActionHandle<Action>(connection, action, result.id)\n          );\n        } else {\n          handle = new BackgroundActionHandle<Action>(connection, action, mutationData.backgroundAction.id);\n        }\n      }\n    }\n  }\n\n  if (isBulk) {\n    return { ...result, error, handles } as EnqueueHookState<Action>;\n  } else {\n    return { ...result, error, handle } as EnqueueHookState<Action>;\n  }\n};\n"]}