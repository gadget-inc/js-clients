{"version":3,"file":"useHasManyController.js","sourceRoot":"","sources":["../../../../src/auto/hooks/useHasManyController.tsx"],"names":[],"mappings":"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","sourcesContent":["import { useCallback, useMemo } from \"react\";\nimport { GadgetFieldType, type GadgetHasManyConfig } from \"../../internal/gql/graphql.js\";\nimport { useFieldArray } from \"../../useActionForm.js\";\nimport type { AutoRelationshipInputProps } from \"../interfaces/AutoRelationshipInputProps.js\";\nimport { useFieldMetadata } from \"./useFieldMetadata.js\";\nimport { useRelatedModelOptions } from \"./useRelatedModel.js\";\nimport { assertFieldType } from \"./utils.js\";\n\nexport const useHasManyController = (props: { field: string }) => {\n  const { field } = props;\n  const fieldMetadata = useFieldMetadata(field);\n  const { path, metadata } = fieldMetadata;\n\n  assertFieldType({\n    fieldApiIdentifier: field,\n    actualFieldType: metadata.fieldType,\n    expectedFieldType: GadgetFieldType.HasMany,\n  });\n\n  const fieldArray = useFieldArray({ name: path, keyName: \"_fieldArrayKey\" });\n\n  const records: Record<string, any>[] = useMemo(() => {\n    return fieldArray.fields.map((field) => {\n      const { _fieldArrayKey, ...rest } = field;\n      return rest;\n    });\n  }, [fieldArray.fields]);\n\n  return {\n    fieldArrayPath: path,\n    fieldMetadata,\n    fieldArray,\n    records,\n  };\n};\n\nexport const useHasManyInputController = (props: AutoRelationshipInputProps) => {\n  const { field } = props;\n  const { fieldMetadata, fieldArray, records } = useHasManyController({ field });\n\n  const { metadata } = fieldMetadata;\n  const inverseFieldApiIdentifier = useMemo(() => {\n    return (metadata.configuration as GadgetHasManyConfig).inverseField?.apiIdentifier;\n  }, [metadata.configuration]);\n\n  const { remove, append, update } = fieldArray;\n  const relatedModelOptions = useRelatedModelOptions({\n    field,\n    recordLabel: { primary: props.optionLabel },\n    recordFilter: props.recordFilter,\n  });\n\n  const { relatedModel } = relatedModelOptions;\n\n  const errorMessage = relatedModel.error?.message;\n  const isLoading = relatedModel.fetching;\n\n  const selectedRecords = useMemo(() => {\n    return (records ?? []).filter((value: { _unlink?: string }) => !(\"_unlink\" in value && value._unlink));\n  }, [records]);\n\n  const onRemoveRecord = useCallback(\n    (record: Record<string, any>) => {\n      const index = records.findIndex((value) => value.id === record.id);\n\n      if (index < 0) {\n        return;\n      }\n\n      if (\"_link\" in record) {\n        remove(index);\n      } else {\n        update(index, {\n          ...record,\n          _unlink: { id: record.id, inverseFieldApiIdentifier },\n        });\n      }\n    },\n    [inverseFieldApiIdentifier, records, remove, update]\n  );\n\n  const onSelectRecord = useCallback(\n    (record: Record<string, any>) => {\n      const index = (records ?? []).findIndex((value) => value.id === record.id);\n\n      if (index >= 0) {\n        const value = records[index];\n        if (\"_unlink\" in value && value._unlink) {\n          const { _unlink, ...rest } = value;\n          update(index, rest);\n        } else {\n          onRemoveRecord(record);\n        }\n      } else {\n        append({\n          ...record,\n          _link: record.id,\n        });\n      }\n    },\n    [records, onRemoveRecord, update, append]\n  );\n\n  return {\n    fieldMetadata,\n    relatedModelOptions,\n    selectedRecords,\n    errorMessage,\n    isLoading,\n    onSelectRecord,\n    onRemoveRecord,\n  };\n};\n"]}