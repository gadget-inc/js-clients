{"version":3,"file":"useHasManyThroughForm.js","sourceRoot":"","sources":["../../src/useHasManyThroughForm.ts"],"names":[],"mappings":"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","sourcesContent":["import { useEffect, useMemo } from \"react\";\nimport { extractPathsFromChildren } from \"./auto/AutoForm.js\";\nimport { useAutoRelationship, useRelationshipContext } from \"./auto/hooks/useAutoRelationship.js\";\nimport { useHasManyThroughController } from \"./auto/hooks/useHasManyThroughController.js\";\nimport { useOptionLabelForField } from \"./auto/hooks/useRelatedModel.js\";\nimport type { OptionLabel } from \"./auto/interfaces/AutoRelationshipInputProps.js\";\nimport { useFormContext } from \"./useActionForm.js\";\n\nexport const useHasManyThroughForm = (props: {\n  field: string;\n  label?: React.ReactNode;\n  children: React.ReactNode;\n  primaryLabel?: OptionLabel;\n  secondaryLabel?: OptionLabel;\n  tertiaryLabel?: OptionLabel;\n}) => {\n  const { field, children } = props;\n  const { metadata } = useAutoRelationship({ field });\n  const { setValue } = useFormContext();\n  const childPaths = children && extractPathsFromChildren(children);\n  const hasChildForm = childPaths && childPaths.length > 0;\n\n  const { fieldArrayPath, fieldArray, records, relatedModelOptions, inverseRelatedModelField, joinModelField, joinModelApiIdentifier } =\n    useHasManyThroughController(props);\n\n  const { fields, append, remove } = fieldArray;\n  const relationshipContext = useRelationshipContext();\n  const pathPrefix = relationshipContext?.transformPath ? relationshipContext.transformPath(props.field) : props.field;\n  const metaDataPathPrefix = relationshipContext?.transformMetadataPath\n    ? relationshipContext.transformMetadataPath(props.field)\n    : pathPrefix;\n\n  useEffect(() => {\n    for (const [index, field] of fields.entries()) {\n      if (\n        inverseRelatedModelField &&\n        (field as any)[inverseRelatedModelField] &&\n        (field as any)[inverseRelatedModelField].id &&\n        !(\"_link\" in field)\n      ) {\n        // use setValue so that we don't trigger a re-render\n        setValue(`${fieldArrayPath}.${index}.${inverseRelatedModelField}._link`, (field as any)[inverseRelatedModelField].id);\n      }\n    }\n  }, [setValue, inverseRelatedModelField, fields, fieldArrayPath]);\n\n  const listboxId = `HasManyThroughListboxInPopover-${field}`;\n\n  if (metadata?.configuration.__typename !== \"GadgetHasManyThroughConfig\") {\n    throw new Error(\"AutoHasManyThroughForm can only be used for HasManyThrough fields\");\n  }\n\n  const {\n    search,\n    searchFilterOptions: siblingModelOptions,\n    relatedModel: { fetching: siblingRecordsLoading, records: siblingRecords },\n    pagination: siblingPagination,\n  } = relatedModelOptions;\n  const siblingModelName = metadata.name ?? \"Unknown\";\n\n  const joinRecords = useMemo(() => {\n    return fields.flatMap((field, idx): [string, number, Record<string, any>][] => {\n      const record = records[idx];\n\n      if (!record) {\n        return [];\n      }\n\n      return [[field._fieldArrayKey, idx, record]];\n    });\n  }, [fields, records]);\n\n  const primaryLabel = useOptionLabelForField(field, props.primaryLabel);\n\n  return {\n    fields,\n    append,\n    remove,\n    joinRecords,\n    primaryLabel,\n    hasChildForm,\n    childPaths,\n    listboxId,\n    pathPrefix,\n    metaDataPathPrefix,\n    siblingModelName,\n    siblingRecordsLoading,\n    siblingRecords,\n    siblingPagination,\n    search,\n    siblingModelOptions,\n    metadata,\n    joinModelField,\n    joinModelApiIdentifier,\n    inverseRelatedModelField,\n    fieldArrayPath,\n    fieldArray,\n    field,\n    records,\n    children,\n    relatedModelOptions,\n  };\n};\n"]}