{"version":3,"file":"ErrorWrapper.js","sourceRoot":"","sources":["../../src/ErrorWrapper.ts"],"names":[],"mappings":"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","sourcesContent":["import { GraphQLError } from \"@0no-co/graphql.web\";\nimport type { CombinedError } from \"@urql/core\";\nimport {\n  GadgetError,\n  InvalidFieldError,\n  InvalidRecordError,\n  gadgetErrorFor,\n  getNonNullableError,\n  type FetchableResult,\n} from \"./support.js\";\n\n/**\n * An error returned by any of the Gadget hooks.\n * Always has a message, but can be inspected to retrieve more detailed errors from either the network, the raw GraphQL layer, or Gadget specific errors like validation errors.\n * Not intended for creating outside of Gadget-owned code.\n **/\nexport class ErrorWrapper extends Error {\n  /** @private */\n  static forClientSideError(error: Error, response?: any) {\n    return new ErrorWrapper({\n      executionErrors: [error],\n      response,\n    });\n  }\n  /** @private */\n  static forErrorsResponse(errors: Record<string, any>[], response?: any) {\n    return new ErrorWrapper({\n      executionErrors: errors.map(gadgetErrorFor),\n      response,\n    });\n  }\n  /** @private */\n  static forMaybeCombinedError(error?: CombinedError | null) {\n    if (!error) return undefined;\n    return new ErrorWrapper({\n      networkError: error.networkError,\n      executionErrors: error.graphQLErrors,\n      response: error.response,\n    });\n  }\n  /** @private */\n  static errorIfDataAbsent(result: FetchableResult & { error?: CombinedError | null }, dataPath: string[], paused = false) {\n    const nonNullableError = getNonNullableError(result, dataPath);\n    let error = ErrorWrapper.forMaybeCombinedError(result.error);\n    if (!error && nonNullableError && !paused) {\n      error = ErrorWrapper.forClientSideError(nonNullableError);\n    }\n    return error;\n  }\n\n  /** Error message for this error. Derived from the other errors this wraps. */\n  public message: string;\n  /**\n   * A list of errors encountered by the backend when processing a request. Populated if the client successfully communicated with the backend, but the backend was unable to process the request and rejected it with an error.\n   * Includes GraphQL syntax errors, missing or invalid argument errors, data validation errors, or unexpected errors encountered when running backend logic.\n   **/\n  public executionErrors: (GraphQLError | GadgetError)[];\n  /**\n   * An error encountered when trying to communicate with the backend from the client. Includes things like connection timeouts, connection interrupts, or no internet connection errors\n   **/\n  public networkError?: Error;\n\n  /**\n   * A list of errors encountered by the backend when processing a request. Populated if the client successfully communicated with the backend, but the backend was unable to process the request and rejected it with an error.\n   * Includes GraphQL syntax errors, missing or invalid argument errors, data validation errors, or unexpected errors encountered when running backend logic.\n   *\n   * This property allows this object to match the interface of urql's `CombinedError` object.\n   *\n   * @deprecated use `executionErrors` instead for a list of the errors that the GraphQL backend API returned *and* client side errors from unexpected responses.\n   **/\n  public graphQLErrors: GraphQLError[];\n\n  /**\n   * The response from the server, if any was retrieved.\n   */\n  public response?: any;\n\n  constructor({\n    networkError,\n    executionErrors,\n    response,\n  }: {\n    networkError?: Error;\n    executionErrors?: Array<string | Partial<GraphQLError> | Error>;\n    validationErrors?: InvalidFieldError[];\n    response?: any;\n  }) {\n    const normalizedExecutionErrors = (executionErrors || []).map(rehydrateGraphQlError);\n    const message = generateErrorMessage(networkError, normalizedExecutionErrors);\n\n    super(message);\n\n    this.message = message;\n    this.executionErrors = normalizedExecutionErrors;\n    this.graphQLErrors = normalizedExecutionErrors;\n    this.networkError = networkError;\n    this.response = response;\n  }\n\n  /** Class name of this error -- always `ErrorWrapper` */\n  get name() {\n    return \"ErrorWrapper\";\n  }\n\n  toString() {\n    return this.message;\n  }\n\n  /**\n   * A list of errors the backend reported for specific fields being invalid for the records touched by an action. Is a shortcut for accessing the validation errors of a `GadgetInvalidRecordError` if that's what is in the `executionErrors`.\n   **/\n  public get validationErrors(): InvalidFieldError[] | null {\n    // eslint-disable-next-line @typescript-eslint/no-unnecessary-type-assertion\n    const firstInvalidRecordError = this.executionErrors.find((err) => (err as any).code == \"GGT_INVALID_RECORD\") as\n      | InvalidRecordError\n      | undefined;\n\n    return firstInvalidRecordError?.validationErrors ?? null;\n  }\n}\n\nconst rehydrateGraphQlError = (error: any): GraphQLError => {\n  if (typeof error === \"string\") {\n    return new GraphQLError(error);\n  } else if (error?.message && !error.code) {\n    return new GraphQLError(error.message, error.nodes, error.source, error.positions, error.path, error, error.extensions || {});\n  } else {\n    return error;\n  }\n};\n\nconst generateErrorMessage = (networkErr?: Error, graphQlErrs?: GraphQLError[]) => {\n  let error = \"\";\n  if (networkErr !== undefined) {\n    error = `[Network] ${networkErr.message}`;\n  } else if (graphQlErrs !== undefined) {\n    graphQlErrs.forEach((err) => {\n      error += `[GraphQL] ${err.message}\\n`;\n    });\n  } else {\n    error = \"Unknown error\";\n  }\n\n  return error.trim();\n};\n"]}